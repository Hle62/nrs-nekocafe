<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>業務管理アプリ</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 15px; background-color: #f4f4f9; color: #333; }
    #app-container { max-width: 600px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h2 { text-align: center; color: #444; }
    #login-section { text-align: center; }
    #login-section select, #login-section button { width: 100%; padding: 12px; margin-top: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 16px; box-sizing: border-box; }
    #login-section button { background-color: #007bff; color: white; border: none; cursor: pointer; transition: background-color 0.3s; }
    #login-section button:disabled { background-color: #cccccc; cursor: not-allowed; }
    #login-message { margin-top: 15px; color: #d9534f; font-weight: bold; }
    #main-app { display: none; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; }
    #current-staff-display { font-size: 14px; color: #555; }
    #logout-button { background: #6c757d; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; }
    .tab-nav { display: flex; margin-bottom: 20px; border-bottom: 2px solid #ddd; }
    .tab-button { flex: 1; padding: 12px; text-align: center; background: #e9ecef; border: none; cursor: pointer; font-size: 16px; border-radius: 5px 5px 0 0; }
    .tab-button.active { background: #fff; border: 2px solid #ddd; border-bottom: 2px solid #fff; margin-bottom: -2px; font-weight: bold; }
    .form-content { display: none; border: 1px solid #ddd; padding: 20px; border-top: none; border-radius: 0 0 8px 8px; }
    .form-group { margin-bottom: 15px; }
    label { font-weight: bold; display: block; margin-bottom: 5px; }
    input[type="number"], textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
    button[type="submit"] { width: 100%; padding: 12px; background: #28a745; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; transition: background-color 0.3s; }
    button[type="submit"]:disabled { background-color: #cccccc; }
    .item-box { padding: 8px 0; border-bottom: 1px solid #eee; }
    .item-box:last-child { border-bottom: none; }
    .quantity-controls { display: none; align-items: center; gap: 5px; flex-wrap: wrap; }
    #sale-total-display { font-size: 1.2em; font-weight: bold; text-align: right; margin-top: 20px; color: #007bff; }
  </style>
</head>
<body>
  <div id="app-container" style="display:none;">
    <div id="login-section">
      <h2>業務管理アプリ ログイン</h2>
      <div class="form-group">
        <select id="login-staff"><option value="">-- 名前を読み込み中 --</option></select>
      </div>
      <button onclick="attemptLogin(event)">ログイン</button>
      <p id="login-message"></p>
    </div>
    <div id="main-app">
      <div class="header">
        <span id="current-staff-display"></span>
        <button id="logout-button" onclick="logout()">ログアウト</button>
      </div>
      <div class="tab-nav">
        <button class="tab-button" onclick="showTab('stock')">在庫補充</button>
        <button class="tab-button" onclick="showTab('expense')">経費申請</button>
        <button class="tab-button" onclick="showTab('sale')">販売記録</button>
      </div>
      <form id="stock-form" class="form-content" onsubmit="submitData(event, '在庫補充')">
        <div class="form-group" id="stock-item-list"></div>
        <div class="form-group">
          <label for="memo-stock">メモ</label>
          <textarea id="memo-stock" rows="3"></textarea>
        </div>
        <button type="submit">在庫を補充する</button>
      </form>
      <form id="expense-form" class="form-content" onsubmit="submitData(event, '経費申請')">
        <div class="form-group">
          <label for="amount-expense">金額</label>
          <input type="number" id="amount-expense" required>
        </div>
        <div class="form-group">
          <label for="memo-expense">メモ</label>
          <textarea id="memo-expense" rows="3"></textarea>
        </div>
        <button type="submit">経費を申請する</button>
      </form>
      <form id="sale-form" class="form-content" onsubmit="submitData(event, '販売記録')">
        <div class="form-group" id="sale-item-list"></div>
        <div class="form-group">
          <label for="memo-sale">メモ</label>
          <textarea id="memo-sale" rows="3"></textarea>
        </div>
        <div id="sale-total-display">合計金額 ¥0</div>
        <button type="submit">販売を記録する</button>
      </form>
    </div>
  </div>

  <script>
    const GAS_WEB_APP_URL = '（ここにステップ3でコピーしたURLを貼り付け）'; 
    const PRICES = { '食べ物': 30000, '飲み物': 30000, 'ジョイント': 20000, '賄い': 10000 };
    let productList = [];

    function logout() { localStorage.removeItem('loggedInStaff'); window.location.reload(); }
    function showMainApp(staffName) {
      document.getElementById('current-staff-display').textContent = `${staffName}さんとしてログイン中`;
      document.getElementById('login-section').style.display = 'none';
      document.getElementById('main-app').style.display = 'block';
      showTab('stock');
    }

    async function fetchStaffNames() {
      const staffDropdown = document.getElementById('login-staff');
      try {
        const response = await fetch(`${GAS_WEB_APP_URL}?action=getStaffNames`);
        const staffNames = await response.json();
        if (staffNames.error) throw new Error(staffNames.error);
        staffDropdown.innerHTML = '<option value="">-- 名前を選択してください --</option>';
        staffNames.forEach(name => {
          const option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          staffDropdown.appendChild(option);
        });
      } catch (error) {
        console.error('従業員リスト取得エラー:', error);
        staffDropdown.innerHTML = '<option value="">エラー: 取得失敗</option>';
        alert(`従業員リストの取得に失敗しました: ${error.message}`);
      }
    }

    async function fetchProductData() {
      const loadingMessage = '<p>商品リストを読み込み中...</p>';
      document.getElementById('stock-item-list').innerHTML = loadingMessage;
      document.getElementById('sale-item-list').innerHTML = loadingMessage;
      try {
        const response = await fetch(`${GAS_WEB_APP_URL}?action=getProducts`);
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        productList = data.sort((a, b) => a.name.localeCompare(b.name, 'ja'));
        renderItemLists();
      } catch (error) {
        console.error('商品情報取得エラー:', error);
        const errorMessage = '<p style="color:red;">エラー: 商品リストの取得に失敗しました。</p>';
        document.getElementById('stock-item-list').innerHTML = errorMessage;
        document.getElementById('sale-item-list').innerHTML = errorMessage;
        alert(`商品情報の取得に失敗しました: ${error.message}`);
        throw error;
      }
    }

    function renderItemLists() {
      const stockListDiv = document.getElementById('stock-item-list');
      const saleListDiv = document.getElementById('sale-item-list');
      stockListDiv.innerHTML = '<label>在庫補充商品</label><br>';
      saleListDiv.innerHTML = '<label>販売記録商品</label><br>';
      productList.forEach((product, index) => {
        const productId = `item-${index}`;
        const createItemHtml = (type) => `
          <div class="item-box">
            <input type="checkbox" id="${type}-${productId}" name="${type}_item" value="${product.name}" data-category="${product.category}" style="width: auto;">
            <label for="${type}-${productId}" style="display: inline; font-weight: normal;">${product.name}</label>
            <div id="${type}-qty-controls-${productId}" class="quantity-controls">
              <label for="qty-${type}-${productId}">数量</label>
              <input type="number" id="qty-${type}-${productId}" min="0" value="0" style="width: 60px;">
              <button type="button" onclick="updateQuantity('qty-${type}-${productId}', 1, '${type}')">+1</button>
              <button type="button" onclick="updateQuantity('qty-${type}-${productId}', 5, '${type}')">+5</button>
              <button type="button" onclick="resetSingleQuantity('qty-${type}-${productId}', '${type}')">0</button>
            </div>
          </div>`;
        stockListDiv.insertAdjacentHTML('beforeend', createItemHtml('stock'));
        saleListDiv.insertAdjacentHTML('beforeend', createItemHtml('sale'));
      });
      document.querySelectorAll('input[type="checkbox"][name$="_item"]').forEach(cb => cb.addEventListener('change', handleCheckboxChange));
      document.querySelectorAll('input[id^="qty-sale-"]').forEach(input => {
        input.addEventListener('input', updateSaleTotalDisplay);
        input.addEventListener('change', updateSaleTotalDisplay);
      });
      updateSaleTotalDisplay();
    }

    function handleCheckboxChange(e) {
      const [type, ...idParts] = e.target.id.split('-');
      const controls = document.getElementById(`${type}-qty-controls-${idParts.join('-')}`);
      if (controls) {
        controls.style.display = e.target.checked ? 'flex' : 'none';
        const input = document.getElementById(`qty-${type}-${idParts.join('-')}`);
        if (!e.target.checked && input) input.value = 0;
        if (type === 'sale') updateSaleTotalDisplay();
      }
    }

    function updateQuantity(inputId, value, type) {
      const input = document.getElementById(inputId);
      input.value = Math.max(0, (parseInt(input.value) || 0) + value);
      if (type === 'sale') input.dispatchEvent(new Event('change'));
    }

    function resetSingleQuantity(inputId, type) {
      const input = document.getElementById(inputId);
      if (input) {
        input.value = 0;
        if (type === 'sale') input.dispatchEvent(new Event('change'));
      }
    }

    function updateSaleTotalDisplay() {
      let totalSales = 0;
      document.querySelectorAll('input[name="sale_item"]:checked').forEach(cb => {
        const qty = parseInt(document.getElementById(`qty-sale-${cb.id.substring(5)}`).value) || 0;
        if (qty > 0) totalSales += qty * (PRICES[cb.dataset.category] || 0);
      });
      document.getElementById('sale-total-display').textContent = `合計金額 ¥${totalSales.toLocaleString()}`;
    }

    function checkLoginStatus() {
      const loggedInStaff = localStorage.getItem('loggedInStaff');
      if (loggedInStaff) {
        document.getElementById('login-section').style.display = 'none';
        fetchProductData().then(() => showMainApp(loggedInStaff)).catch(() => {
          localStorage.removeItem('loggedInStaff');
          window.location.reload();
        });
        return true;
      }
      return false;
    }

    async function attemptLogin(event) {
      const loginButton = event.target;
      const staffName = document.getElementById('login-staff').value;
      const messageElement = document.getElementById('login-message');
      if (!staffName) { messageElement.textContent = '名前を選択してください。'; return; }
      loginButton.textContent = '認証中...';
      loginButton.disabled = true;
      try {
        const response = await fetch(`${GAS_WEB_APP_URL}?staffName=${encodeURIComponent(staffName)}`);
        const result = await response.json();
        if (!result.authenticated) throw new Error('認証に失敗しました。');
        localStorage.setItem('loggedInStaff', staffName);
        messageElement.textContent = '商品リストをロード中...';
        await fetchProductData();
        showMainApp(staffName);
      } catch (error) {
        messageElement.textContent = 'エラー: 登録されていないか通信に問題があります。';
        loginButton.textContent = 'ログイン';
        loginButton.disabled = false;
      }
    }

    function showTab(tabId) {
      document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
      document.querySelector(`.tab-button[onclick*="'${tabId}'"]`).classList.add('active');
      document.querySelectorAll('.form-content').forEach(c => c.style.display = 'none');
      document.getElementById(`${tabId}-form`).style.display = 'block';
    }

    async function submitData(event, type) {
      event.preventDefault();
      const submitButton = event.target.querySelector('button[type="submit"]');
      const originalButtonText = submitButton.textContent;
      submitButton.textContent = '送信中...';
      submitButton.disabled = true;
      try {
        const loggedInStaff = localStorage.getItem('loggedInStaff');
        if (!loggedInStaff) throw new Error('ログインが失効しました。');
        let records = [];
        const form = event.target;
        if (type === '在庫補充') {
          const memo = form.querySelector('#memo-stock').value;
          form.querySelectorAll('input[name="stock_item"]:checked').forEach(item => {
            const qty = parseInt(document.getElementById(`qty-stock-${item.id.substring(6)}`).value);
            if (isNaN(qty) || qty < 1) throw new Error(`「${item.value}」の数量を1以上で入力してください。`);
            records.push({ "商品名": item.value, "数量": qty, "メモ": memo });
          });
          if (records.length === 0) {
            if (memo.trim()) records.push({ "商品名": 'メモのみ', "数量": 0, "メモ": memo });
            else throw new Error('補充する商品を1つ以上選択してください。');
          }
        } else if (type === '経費申請') {
          records.push({ "費目": '材料費', "金額": form.querySelector('#amount-expense').value, "メモ": form.querySelector('#memo-expense').value });
        } else if (type === '販売記録') {
          const memo = form.querySelector('#memo-sale').value;
          form.querySelectorAll('input[name="sale_item"]:checked').forEach(item => {
            const qty = parseInt(document.getElementById(`qty-sale-${item.id.substring(5)}`).value);
            if (isNaN(qty) || qty < 1) throw new Error(`「${item.value}」の数量を1以上で入力してください。`);
            records.push({ "商品名": item.value, "数量": qty, "売上金額": (PRICES[item.dataset.category] || 0) * qty, "メモ": memo });
          });
          if (records.length === 0) throw new Error('販売した商品を1つ以上選択してください。');
        }
        const response = await fetch(GAS_WEB_APP_URL, { method: 'POST', body: JSON.stringify({type, 担当者名: loggedInStaff, records}) });
        const result = await response.json();
        if (result.result !== 'success') throw new Error(result.message || '不明なサーバーエラー');
        alert(`${type}のデータが正常に送信されました。`);
        form.reset();
        document.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
          cb.checked = false;
          cb.dispatchEvent(new Event('change'));
        });
      } catch (e) {
        alert(`エラー: ${e.message}`);
        if(e.message.includes('失効')) window.location.reload();
      } finally {
        submitButton.textContent = originalButtonText;
        submitButton.disabled = false;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('app-container').style.display = 'block';
      if (!checkLoginStatus()) {
        fetchStaffNames();
      }
    });
  </script>
</body>
</html>